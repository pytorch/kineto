<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ProfilePlugin</title>
  <script>
    const base = document.createElement("base");
    const defaultPath = '/data/plugin/profile';
    let newPath = defaultPath + '/';
    if (document.location.pathname.includes(defaultPath)) {
      newPath = document.location.pathname.split(defaultPath)[0] + defaultPath + '/';
    }
    base.setAttribute("href", newPath);
    const header = document.getElementsByTagName("head")[0];
    header.insertBefore(base, header.firstChild);
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="styles.css">
  <!-- zone.js -->
</head>
<body>
  <app></app>
  <script>
    function loadBundle() {
      const script = document.createElement('script');
      script.src = 'bundle.js';
      document.body.appendChild(script);
      return script;
    }

    function loadChart(domain) {
      const script = document.createElement('script');
      script.src = `https://${domain}/charts/loader.js`;
      document.body.appendChild(script);
      script.onload = () => {
        loadBundle();
      }
      return script;
    }

    function setReloadOfIFrame() {
      try {
        const tfTensorboard =
              window.parent.document.querySelector('tf-tensorboard');
        const iFrame = tfTensorboard.shadowRoot.querySelector(
          'div[data-dashboard="profile"] > iframe');
        iFrame.reload = () => {
          if (tfTensorboard.autoReloadEnabled) {
            document.dispatchEvent(new Event('tensorboard-reload'));
          } else {
            const defaultPath = '/data/plugin/profile';
            let newPath = defaultPath + '/';
            if (document.location.pathname.includes(defaultPath)) {
              newPath = document.location.pathname.split(defaultPath)[0] + defaultPath + '/';
            }
            document.location.href = document.location.origin + newPath + 'index.html';
          }
        };
      } catch (err) {
      }
      document.addEventListener('plugin-reload', () => {
          const defaultPath = '/data/plugin/profile';
          let newPath = defaultPath + '/';
          if (document.location.pathname.includes(defaultPath)) {
            newPath = document.location.pathname.split(defaultPath)[0] + defaultPath + '/';
          }
          document.location.href = document.location.origin + newPath + 'index.html';
      });
    }

    const script = loadChart('www.gstatic.com');
    script.onerror = () => {
      script.onerror = null;
      document.body.removeChild(script);

      loadChart('www.gstatic.cn');
    }
    setReloadOfIFrame();
  </script>
</body>
</html>
